<!DOCTYPE html>
<html>
<head>
    <title>传感器数据监控</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container">
        <header>
            <h1>传感器数据实时监控系统</h1>
        </header>

        <div id="notification-container"></div>

        <div class="main-content">
            <div class="content-left">
                <div class="client-selector">
                    <label for="clientSelector">选择客户端：</label>
                    <select id="clientSelector" onchange="handleClientSelection(this.value)">
                        <option value="all">所有客户端</option>
                    </select>
                </div>

                <div class="dashboard">
                    <div class="chart-container">
                        <canvas id="temperatureChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="humidityChart"></canvas>
                    </div>
                </div>

                <div class="data-section">
                    <div class="data-header">
                        <h2>实时数据</h2>
                        <div class="pagination">
                            <button id="prevPage" class="page-btn"><i class="fas fa-chevron-left"></i></button>
                            <span id="pageInfo">第 1 页</span>
                            <button id="nextPage" class="page-btn"><i class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                    
                    <div class="data-table-container">
                        <table id="sensorData">
                            <thead>
                                <tr>
                                    <th>时间</th>
                                    <th>客户端</th>
                                    <th>温度(°C)</th>
                                    <th>湿度(%)</th>
                                    <th>状态</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="content-right">
                <div class="online-clients-panel">
                    <h2>在线客户端</h2>
                    <div id="onlineClientsList">
                        <!-- 在线客户端将动态添加在这里 -->
                    </div>
                </div>

                <div class="client-history">
                    <h2>客户端状态历史</h2>
                    <div class="history-container" id="statusHistory">
                        <!-- 状态历史记录将在这里动态添加 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let currentPage = 1;
        const rowsPerPage = 10;
        let allData = [];
        const clients = new Map();
        let selectedClient = null;

        // 初始化Socket.IO连接
        const socket = io();

        // 初始化默认图表
        const tempChart = new Chart(document.getElementById('temperatureChart').getContext('2d'), {
            type: 'line',
            data: {
                labels: [],
                datasets: []
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: '温度趋势图'
                    },
                    legend: {
                        position: 'top',
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false
                    }
                }
            }
        });

        const humidChart = new Chart(document.getElementById('humidityChart').getContext('2d'), {
            type: 'line',
            data: {
                labels: [],
                datasets: []
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: '湿度趋势图'
                    },
                    legend: {
                        position: 'top',
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false
                    }
                }
            }
        });

        // 更新在线客户端列表
        function updateOnlineClientsList() {
            const list = document.getElementById('onlineClientsList');
            list.innerHTML = '';
            
            clients.forEach((value, clientId) => {
                const item = document.createElement('div');
                item.className = 'online-client-item';
                item.innerHTML = `
                    <span class="status-icon online"></span>
                    <span class="client-name">${clientId}</span>
                `;
                list.appendChild(item);
            });
        }

        // 添加状态历史记录
        function addStatusHistory(clientId, isOnline, timestamp) {
            const historyContainer = document.getElementById('statusHistory');
            const status = isOnline ? '上线' : '下线';
            const statusClass = isOnline ? 'online' : 'offline';
            
            const historyItem = document.createElement('div');
            historyItem.className = 'history-item';
            historyItem.innerHTML = `
                <span class="history-time">${timestamp}</span>
                <span class="history-client">${clientId}</span>
                <span class="history-status ${statusClass}">${status}</span>
            `;
            
            historyContainer.insertBefore(historyItem, historyContainer.firstChild);
            
            if (historyContainer.children.length > 50) {
                historyContainer.removeChild(historyContainer.lastChild);
            }
        }

        // 更新表格数据
        function updateTable() {
            const tbody = document.getElementById('sensorData').getElementsByTagName('tbody')[0];
            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const pageData = allData.slice(start, end);
            
            tbody.innerHTML = '';
            pageData.forEach(data => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${data.timestamp}</td>
                    <td>${data.client_id}</td>
                    <td>${data.temperature}</td>
                    <td>${data.humidity}</td>
                    <td><span class="status-badge online">在线</span></td>
                `;
            });
            
            document.getElementById('pageInfo').textContent = 
                `第 ${currentPage} 页 / 共 ${Math.ceil(allData.length / rowsPerPage)} 页`;
            
            document.getElementById('prevPage').disabled = currentPage === 1;
            document.getElementById('nextPage').disabled = 
                currentPage >= Math.ceil(allData.length / rowsPerPage);
        }

        // 显示通知
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = message;
            
            const container = document.getElementById('notification-container');
            container.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('fade-out');
                setTimeout(() => {
                    container.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // 处理客户端选择
        function handleClientSelection(clientId) {
            selectedClient = clientId;
            updateCharts();
        }

        // 修改客户端状态变化处理
        socket.on('client_status', function(data) {
            const {client_id, status, timestamp} = data;
            
            if (status === 'online') {
                if (!clients.has(client_id)) {
                    clients.set(client_id, {
                        data: [],
                        color: getRandomColor()
                    });
                    // 更新客户端选择器
                    updateClientSelector();
                }
                showNotification(`${client_id} 已连接`, 'success');
            } else if (status === 'offline') {
                if (clients.has(client_id)) {
                    clients.delete(client_id);
                    // 更新客户端选择器
                    updateClientSelector();
                }
                showNotification(`${client_id} 已断开连接`, 'warning');
            }
            
            // 更新在线客户端列表
            updateOnlineClientsList();
            // 更新状态历史
            addStatusHistory(client_id, status === 'online', timestamp);
            // 更新图表
            updateCharts();
        });

        // 更新客户端选择器
        function updateClientSelector() {
            const selector = document.getElementById('clientSelector');
            const currentValue = selector.value;
            selector.innerHTML = '<option value="all">所有客户端</option>';
            
            clients.forEach((value, clientId) => {
                const option = document.createElement('option');
                option.value = clientId;
                option.textContent = clientId;
                selector.appendChild(option);
            });

            // 保持当前选择（如果客户端还存在）
            if (currentValue === 'all' || clients.has(currentValue)) {
                selector.value = currentValue;
            } else {
                selector.value = 'all';
                selectedClient = 'all';
            }
        }

        // 修改图表更新函数
        function updateCharts() {
            // 清除现有数据
            tempChart.data.labels = [];
            humidChart.data.labels = [];
            tempChart.data.datasets = [];
            humidChart.data.datasets = [];

            // 根据选择的客户端添加数据集
            clients.forEach((client, clientId) => {
                if (selectedClient === 'all' || selectedClient === clientId) {
                    if (client.data.length > 0) {
                        const tempDataset = {
                            label: `${clientId} 温度`,
                            data: client.data.slice().reverse().map(d => d.temperature),
                            borderColor: client.color,
                            tension: 0.4
                        };
                        const humidDataset = {
                            label: `${clientId} 湿度`,
                            data: client.data.slice().reverse().map(d => d.humidity),
                            borderColor: client.color,
                            tension: 0.4
                        };

                        tempChart.data.datasets.push(tempDataset);
                        humidChart.data.datasets.push(humidDataset);

                        // 添加时间标签（只需要一个客户端的时间标签）
                        if (tempChart.data.labels.length === 0) {
                            tempChart.data.labels = client.data.slice().reverse().map(d => d.timestamp);
                            humidChart.data.labels = client.data.slice().reverse().map(d => d.timestamp);
                        }
                    }
                }
            });

            tempChart.update();
            humidChart.update();
        }

        // 修改传感器数据处理函数
        socket.on('sensor_data', function(data) {
            const clientId = data.client_id;
            if (!clients.has(clientId)) return;

            const client = clients.get(clientId);
            client.data.unshift(data);
            if (client.data.length > 100) client.data.pop();

            // 更新所有数据数组
            allData.unshift(data);
            if (allData.length > 100) allData.pop();

            // 更新图表和表格
            if (selectedClient === 'all' || selectedClient === clientId) {
                updateCharts();
            }
            updateTable();
        });

        // 生成随机颜色
        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        // 分页事件处理
        document.getElementById('prevPage').addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                updateTable();
            }
        });

        document.getElementById('nextPage').addEventListener('click', () => {
            if (currentPage < Math.ceil(allData.length / rowsPerPage)) {
                currentPage++;
                updateTable();
            }
        });

        // 初始化选择
        selectedClient = 'all';
    </script>
</body>
</html> 